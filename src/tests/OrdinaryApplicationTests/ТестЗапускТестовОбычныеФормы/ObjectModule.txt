Перем юТест;
Перем ИдетОтладка;

Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	юТест = ЮнитТестирование;
	
	ВсеТесты = Новый Массив;
			
	ВсеТесты.Добавить("Тест_должен_Сделать_Запуск_Тестов_По_ТестовойФиче_Когда_Нет_Исходников_EPF");
	                                                              	
	Возврат ВсеТесты;
	
КонецФункции

Процедура ПередЗапускомТеста() Экспорт
	
			
КонецПроцедуры

Процедура ПослеЗапускаТеста() Экспорт
	
	
КонецПроцедуры


Процедура ПолучитьПутьКОбработке_vanessa_behavior_изПараметровЗапуска(ПутьК_vanessa_behavior,КаталогИнструментов,КаталогФич)
	ПутьК_vanessa_behavior = Неопределено;
КонецПроцедуры

Процедура ПроверитьЧтоВФичуПроставилсяТег(ПутьКФайлу)
	Файл = Новый Файл(ПутьКФайлу);
	ОжидаемоеИмяФичи = "@[ИмяФичи]=" + Файл.ИмяБезРасширения + ";" + Файл.Путь;
	
	Текст = Новый ЧтениеТекста;
	Текст.Открыть(ПутьКФайлу,"UTF-8");
	
	
	
	Нашли = Ложь;
	Пока Истина Цикл
		Стр = Текст.ПрочитатьСтроку();
		Если Стр = Неопределено Тогда
			Прервать;
		КонецЕсли;	 
		
		Если НРег(Стр) = НРег(ОжидаемоеИмяФичи) Тогда
			Нашли = Истина;
			Прервать;
		КонецЕсли;	 
		
	КонецЦикла;
	Текст.Закрыть();
	
	юТест.ПроверитьРавенство(Нашли,Истина,"В фиче нашли нужный тег: " + ОжидаемоеИмяФичи);
	
КонецПроцедуры

Процедура ЗаписатьФайлФичи(ИмяФайла)
	УдалитьФайлы(ИмяФайла);
	
	
	Стр = "# encoding: utf-8
	|# language: ru
	|
	|
	|@[ИмяФичи]=Test;\features\SelfTests
	|
	|
	|
	|
	|Функционал: Проверка генерации простого epf файла.
	|
	|Как Пользователь
	|Я Хочу: чтобы чтобы при нажатии на кнопку Выполнить в толстой форме происходила геренация epf файла
	|
	|Сценарий: Генерация EPF в режиме толстых форм
	| Когда Запущена сервисная база в режиме толстых форм
	| И создана процедура куда передано число 1
	| И создана процедура куда передана строка 'тест'
	| И создана процедура куда передана дата 08.04.1981
	| И не будет обнаружено число в конце слова3
	| И не будет обнаружено число в конце слова с тире-3
	| Тогда будет создан файл 'SimpleGenerateTest.epf'
	| 
	|";
	
	Текст = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8);
	Текст.ЗаписатьСтроку(Стр);
	Текст.Закрыть(); 
КонецПроцедуры


Процедура ОбработатьКаталогФич(КаталогФич)
	Файл = Новый Файл(КаталогФич);
	Если НЕ Файл.ЭтоКаталог() Тогда
		ВызватьИсключение "Для каталога фич должен быть передан каталог, а не файл!";
	КонецЕсли;	 
	
	Если Прав(КаталогФич,1) = "\" Тогда
		КаталогФич = Лев(КаталогФич,СтрДлина(КаталогФич)-1);
	КонецЕсли;	 
КонецПроцедуры


Процедура Тест_должен_Сделать_Запуск_Тестов_По_ТестовойФиче_Когда_Нет_Исходников_EPF() Экспорт
	
	
	ПутьК_vanessa_behavior = "";
	КаталогИнструментов    = "";
	КаталогФич             = "";
	ПолучитьПутьКОбработке_vanessa_behavior_изПараметровЗапуска(ПутьК_vanessa_behavior,КаталогИнструментов,КаталогФич);
	
	Если ПутьК_vanessa_behavior = Неопределено Тогда
		Если Не ИдетОтладка Тогда
			Сообщить("Не передан путь к vanessa_behavior.epf!");
			ВызватьИсключение "Не передан путь к vanessa_behavior.epf!";
		КонецЕсли;	  
		
		ПутьК_vanessa_behavior = "E:\commons\Rep\vanessa-bdd\vanessa-behavior.epf";
		КаталогИнструментов    = "E:\commons\Rep\vanessa-bdd";
		КаталогФич             = "E:\Temp\feature";
	КонецЕсли;	 
	
	
	ПутьКЛогуКукумбера = КаталогИнструментов + "\CucumberConsoleLog.txt";
	УдалитьФайлы(ПутьКЛогуКукумбера);
	
	
	Обработка = ВнешниеОбработки.Создать(ПутьК_vanessa_behavior); 
	Обработка.GenerateEpf         = Ложь;
	Обработка.TestRun             = Истина;
	Обработка.КаталогИнструментов = КаталогИнструментов;
	Обработка.ВыполнитьОбработкуПриОткрытии        = Истина;
	Обработка.ЗакрытьФормуПослеВыполненияОбработки = Истина;
	
	ОбработатьКаталогФич(КаталогФич);
	
	ПереданныйКаталог    = КаталогФич;
	
	
	
	
	
	
	
	
	
	Обработка.КаталогФич = КаталогФич + "\Test.feature";
	
	//Обработка.КаталогФич = "E:\commons\Rep\vanessa-bdd\features\SelfTests\SimpleGenerateTest.feature";
	
	Сообщить("Работаю с фичей: " + Обработка.КаталогФич);
	
	ПутьКСгенерированномуEPF = ПереданныйКаталог + "\step_definitions\Test.epf";
	УдалитьФайлы(ПутьКСгенерированномуEPF);
	
	МакетEPF = ПолучитьМакет("EPF");
	МакетEPF.Записать(ПутьКСгенерированномуEPF);
	
	
	ЗаписатьФайлФичи(Обработка.КаталогФич);
	
	
	
	
	Форма =  Обработка.ПолучитьФорму("Форма");
	Форма.ПроставитьТегВФичу(Обработка.КаталогФич);
	Форма.ОткрытьМодально();
	
	Файл = Новый Файл(ПутьКЛогуКукумбера);
	юТест.ПроверитьРавенство(Файл.Существует(),Истина,"Существует лог кукумбера.");
	
	Текст = Новый ЧтениеТекста;
	Текст.Открыть(ПутьКЛогуКукумбера,"UTF-8");
	
	Нашли = Ложь;
	Пока Истина Цикл
		Стр = Текст.ПрочитатьСтроку();
		Если Стр = Неопределено Тогда
			Прервать;
		КонецЕсли;	 
		
		Если Найти(Стр,"1 scenario (1 passed)") > 0 Тогда
			Нашли = Истина;
		КонецЕсли;	 
		
	КонецЦикла;	
	
	Текст.Закрыть();
	
	
	юТест.ПроверитьРавенство(Нашли,Истина,"В логе кукумбера нашли запись о прохождении сценария.");
	
КонецПроцедуры
        
ИдетОтладка = Ложь;
ИдетОтладка = Истина;

Если ИдетОтладка Тогда
	Сообщить("ИдетОтладка " +(этотОбъект.ИспользуемоеИмяФайла));
КонецЕсли;	






 

 
