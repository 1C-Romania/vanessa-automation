Перем юТест;
Перем ИдетОтладка;

Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	юТест = ЮнитТестирование;
	
	ВсеТесты = Новый Массив;
			
	ВсеТесты.Добавить("Тест_должен_открыть_обработку_vanessa_behavior_и_перегенерировать_epf_по_тестовой_фиче");
	                                                              	
	Возврат ВсеТесты;
	
КонецФункции

Процедура ПередЗапускомТеста() Экспорт
	
			
КонецПроцедуры

Процедура ПослеЗапускаТеста() Экспорт
	
	
КонецПроцедуры


Процедура ПолучитьПутьКОбработке_vanessa_behavior_изПараметровЗапуска(ПутьК_vanessa_behavior,КаталогИнструментов,КаталогФич)
	ПутьК_vanessa_behavior = Неопределено;
КонецПроцедуры

Процедура ПроверитьЧтоВФичуПроставилсяТег(ПутьКФайлу)
	Файл = Новый Файл(ПутьКФайлу);
	Путь = Файл.Путь;
	Если Прав(Путь,1) = "\" Тогда
		Путь = Лев(Путь,СтрДлина(Путь)-1);
	КонецЕсли;	 
	ОжидаемоеИмяФичи = "@[ИмяФичи]=" + Файл.ИмяБезРасширения + ";" + Путь;
	
	Текст = Новый ЧтениеТекста;
	Текст.Открыть(ПутьКФайлу,"UTF-8");
	
	
	
	Нашли = Ложь;
	Пока Истина Цикл
		Стр = Текст.ПрочитатьСтроку();
		Если Стр = Неопределено Тогда
			Прервать;
		КонецЕсли;	 
		
		Если НРег(Стр) = НРег(ОжидаемоеИмяФичи) Тогда
			Нашли = Истина;
			Прервать;
		КонецЕсли;	 
		
	КонецЦикла;
	Текст.Закрыть();
	
	юТест.ПроверитьРавенство(Нашли,Истина,"В фиче нашли нужный тег: " + ОжидаемоеИмяФичи);
	
КонецПроцедуры

Процедура ЗаписатьФайлФичи(ИмяФайла)
	УдалитьФайлы(ИмяФайла);
	
	
	Стр = "# encoding: utf-8
	|# language: ru
	|
	|
	|@[ИмяФичи]=Test;\features\SelfTests
	|
	|
	|
	|
	|Функционал: Проверка генерации простого epf файла.
	|
	|Как Пользователь
	|Я Хочу: чтобы чтобы при нажатии на кнопку Выполнить в толстой форме происходила геренация epf файла
	|
	|Сценарий: Генерация EPF в режиме толстых форм
	| Когда Запущена сервисная база в режиме толстых форм
	| И создана процедура куда передано число 1
	| И создана процедура куда передана строка 'тест'
	| И создана процедура куда передана дата 08.04.1981
	| И не будет обнаружено число в конце слова3
	| И не будет обнаружено число в конце слова с тире-3
	| И добавлен новый шаг
	| Тогда будет создан файл 'SimpleGenerateTest.epf'
	| 
	|";
	
	Текст = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8);
	Текст.ЗаписатьСтроку(Стр);
	Текст.Закрыть(); 
КонецПроцедуры

Процедура ОбработатьКаталогФич(КаталогФич)
	Файл = Новый Файл(КаталогФич);
	Если Файл.Расширение <> "" Тогда
		ВызватьИсключение "Для каталога фич должен быть передан каталог, а не файл!";
	КонецЕсли;	 
	
	Если Прав(КаталогФич,1) = "\" Тогда
		КаталогФич = Лев(КаталогФич,СтрДлина(КаталогФич)-1);
	КонецЕсли;	 
КонецПроцедуры


Процедура Тест_должен_открыть_обработку_vanessa_behavior_и_перегенерировать_epf_по_тестовой_фиче() Экспорт
	ПутьК_vanessa_behavior = "";
	КаталогИнструментов    = "";
	КаталогФич             = "";
	ПолучитьПутьКОбработке_vanessa_behavior_изПараметровЗапуска(ПутьК_vanessa_behavior,КаталогИнструментов,КаталогФич);
	
	Если ПутьК_vanessa_behavior = Неопределено Тогда
		Если Не ИдетОтладка Тогда
			Сообщить("Не передан путь к vanessa_behavior.epf!");
			ВызватьИсключение "Не передан путь к vanessa_behavior.epf!";
		КонецЕсли;	  
		
		ПутьК_vanessa_behavior = "E:\commons\Rep\vanessa-bdd\vanessa-behavior.epf";
		КаталогИнструментов    = "E:\commons\Rep\vanessa-bdd";
		КаталогФич             = "E:\Temp\feature";
	КонецЕсли;	 
	
	ВнешниеПереданныеПараметры = Новый Структура;
	
	Обработка = ВнешниеОбработки.Создать(ПутьК_vanessa_behavior); 
	//Обработка.GenerateEpf         = Истина;
	//Обработка.КаталогИнструментов = КаталогИнструментов;
	ВнешниеПереданныеПараметры.Вставить("GenerateEpf",Истина);
	ВнешниеПереданныеПараметры.Вставить("ГенерироватьУФ",Ложь);
	ВнешниеПереданныеПараметры.Вставить("КаталогИнструментов",КаталогИнструментов);
	
	
	ОбработатьКаталогФич(КаталогФич);
	
	
	
	
	ПереданныйКаталог    = КаталогФич;
	
	УдалитьФайлы(ПереданныйКаталог);
	СоздатьКаталог(ПереданныйКаталог);
	СоздатьКаталог(ПереданныйКаталог + "\step_definitions");
	
	
	КаталогФич           = КаталогФич + "\Test.feature";
	ВнешниеПереданныеПараметры.Вставить("КаталогФич",КаталогФич);
	
	//Обработка.КаталогФич = "E:\commons\Rep\vanessa-bdd\features\SelfTests\SimpleGenerateTest.feature";
	
	Сообщить("Работаю с фичей: " + КаталогФич);
	
	ПутьКСгенерированномуEPF = ПереданныйКаталог + "\step_definitions\Test.epf";
	УдалитьФайлы(ПутьКСгенерированномуEPF);
	
	
	ЗаписатьФайлФичи(КаталогФич);
	
	//Обработка.ВыполнитьОбработкуПриОткрытии        = Истина;
	//Обработка.ЗакрытьФормуПослеВыполненияОбработки = Истина;
	ВнешниеПереданныеПараметры.Вставить("ВыполнитьОбработкуПриОткрытии",Истина);
	ВнешниеПереданныеПараметры.Вставить("ЗакрытьФормуПослеВыполненияОбработки",Истина);
	
	
	ПутьКСгенерированномуEPF = ПереданныйКаталог + "\step_definitions\Test.epf";
	УдалитьФайлы(ПутьКСгенерированномуEPF);
	
	МакетEPF = ПолучитьМакет("EPF");
	МакетEPF.Записать(ПутьКСгенерированномуEPF);
	
	
	
	//Форма.ВыполнитьОбработку();
	Форма =  Обработка.ПолучитьФорму("Форма");
	Форма.ВнешниеПереданныеПараметры = ВнешниеПереданныеПараметры;
	Форма.ОткрытьМодально();
	
	ПроверитьЧтоВФичуПроставилсяТег(КаталогФич);
	
	Сообщить("Путь=" + ПутьКСгенерированномуEPF);
	
	Файл = Новый Файл(ПутьКСгенерированномуEPF);
	
	юТест.ПроверитьРавенство(Файл.Существует(),Истина,"Существует сгенерированный файл");
	
	ОбработкаСТестом = ВнешниеОбработки.Создать(ПутьКСгенерированномуEPF); 
	
	//++проверим, что были созданы предопределенные процедуры
	ОбработкаСТестом.ПередНачаломСценария();
	ОбработкаСТестом.ПередОкончаниемСценария();
	//--проверим, что были созданы предопределенные процедуры
	
	//проверим, что в обработке после перегенерации есть макет
	
	
	
	
	Попытка
		ОбработкаСТестом.ЗапущенаСервиснаяБазаВРежимеТолстыхФорм();
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура ЗапущенаСервиснаяБазаВРежимеТолстыхФорм");
	КонецПопытки;
	
	Попытка
		ОбработкаСТестом.СозданаПроцедураКудаПереданоЧисло(1);
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура СозданаПроцедураКудаПереданоЧисло");
	КонецПопытки;
	
	Попытка
		ОбработкаСТестом.СозданаПроцедураКудаПереданаСтрока("тест");
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура СозданаПроцедураКудаПереданаСтрока");
	КонецПопытки;
	
	Попытка
		ОбработкаСТестом.СозданаПроцедураКудаПереданаДата('19810408');
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура СозданаПроцедураКудаПереданаДата");
	КонецПопытки;
	
	Попытка
		ОбработкаСТестом.НеБудетОбнаруженоЧислоВКонцеСлова3();
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура НеБудетОбнаруженоЧислоВКонцеСлова3");
	КонецПопытки;
	
	Попытка
		ОбработкаСТестом.НеБудетОбнаруженоЧислоВКонцеСловаСТире_3();
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура НеБудетОбнаруженоЧислоВКонцеСловаСТире_3");
	КонецПопытки;
	
	Попытка
		ОбработкаСТестом.БудетСозданФайл("тест");
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура БудетСозданФайл");
	КонецПопытки;
	
	
	//проверим, что в epf был добавлен новый шаг, которго раньше не было
	Попытка
		ОбработкаСТестом.ДобавленНовыйШаг();
	Исключение
		//Сообщить("" + ОписаниеОшибки());
		Стр = ОписаниеОшибки();
		юТест.ПроверитьнеРавенство(Найти(Стр,"Не реализовано"),0,"Была правильно создана процедура ДобавленНовыйШаг");
	КонецПопытки;
	
	
	
	
	МакетОбработки = ОбработкаСТестом.ПолучитьМакет("Макет");
	
КонецПроцедуры
        
ИдетОтладка = Ложь;
ИдетОтладка = Истина;

Если ИдетОтладка Тогда
	Сообщить("ИдетОтладка " +(этотОбъект.ИспользуемоеИмяФайла));
КонецЕсли;	






 

 
